<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Inventory Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-W5D595TDW4"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-W5D595TDW4');
	</script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #reader {
            width: 100%;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        #reader__dashboard_section_csr > div > button {
            background-color: #3b82f6 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 0.5rem !important;
            padding: 10px 16px !important;
            width: 100%;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
		body {
	    	display: flex; /* Enables Flexbox */
	    	flex-direction: column; /* Stacks children vertically */
		}
		main {
	    	flex-grow: 1; /* Allows the main content to grow and push the footer down */
		}
		footer {
	    	text-align: center;
	    	padding: 20px;
	    	background-color: #f2f2f2;
		}	
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-lg mx-auto p-4">
        
        <div class="card text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Book Inventory Scanner</h1>
            <p class="text-gray-500 mb-6">Scan barcodes and export to a CSV file...</p>
			<!-- <p class="text-gray-500 mb-6">If I saved you time, consider buying me a coffee <a href="https://www.paypal.com/donate/?hosted_button_id=G44TZRFQ7ZLCL" style="color:blue; text-decoration:underline;">here</a>.</p> -->
			<p class="text-gray-500 mb-6">If I saved you time, consider buying me a coffee <a href="https://venmo.com/code?user_id=2443000105926656085&created=1755518176" style="color:blue; text-decoration:underline;">here</a>.</p>
			
            <!-- ==================================================================================== -->
            <!-- ðŸ›‘ IMPORTANT: CONFIGURATION REQUIRED ðŸ›‘ -->
            <!-- 1. Go to the Google Cloud Console: https://console.cloud.google.com/ -->
            <!-- 2. Create a new project or select an existing one. -->
            <!-- 3. In the sidebar, go to "APIs & Services" -> "Library". -->
            <!-- 4. Search for and ENABLE the "Google Books API". -->
            <!-- 5. Go to "APIs & Services" -> "Credentials". -->
            <!-- 6. Click "+ CREATE CREDENTIALS" and choose "API key". -->
            <!-- 7. Copy the key and paste it into the API_KEY variable in the script below. -->
            <!-- ==================================================================================== -->

            <!-- Inventory Status Section -->
            <div id="inventory-status" class="my-4 p-4 bg-gray-100 rounded-lg">
                <p><span id="inventory-count" class="font-bold text-lg">0</span> books in inventory.</p>
                <div class="flex space-x-2 mt-2">
                    <button id="download-csv-button" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-2 rounded-lg transition-colors disabled:bg-gray-400" disabled>
                        Download CSV
                    </button>
                    <button id="clear-inventory-button" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-2 rounded-lg transition-colors disabled:bg-gray-400" disabled>
                        Clear List
                    </button>
                </div>
            </div>

            <!-- Main Control Section -->
            <div id="main-content">
                <button id="start-scan-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full mb-4 transition-colors">
                    Start Scanning
                </button>

                <!-- Scanner Section -->
                <div id="scanner-container" class="hidden w-full mx-auto my-4">
                    <div id="reader"></div>
                    <button id="stop-scan-button" class="mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg w-full transition-colors">
                        Stop Scanning
                    </button>
                </div>
                
                <!-- Loader -->
                <div id="loader" class="hidden my-4">
                    <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p id="loader-message" class="text-gray-500 mt-2">Loading...</p>
                </div>

                <!-- Message Display -->
                <div id="message-display" class="hidden my-4 p-3 rounded-lg"></div>

                <!-- Book Info Card -->
                <div id="book-info" class="hidden text-left my-4 p-4 border rounded-lg bg-white">
                    <h2 id="book-title" class="text-xl font-bold text-gray-800"></h2>
                    <p id="book-author" class="text-gray-600"></p>
                    <p id="book-isbn" class="text-sm text-gray-400 mt-2"></p>
                    <div class="flex space-x-2 mt-4">
                        <button id="add-to-inventory-button" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-2 rounded-lg transition-colors">Add to Inventory</button>
                        <button id="scan-another-button" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-2 rounded-lg transition-colors">Skip & Scan Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // --- CONFIGURATION ---
        const API_KEY = 'AIzaSyDAv5Iie2wNDFMLYYxDXMf-TmSG6hgGAaI';

        // --- STATE ---
        let bookInventory = [];
        let html5QrCode;

        // --- DOM ELEMENTS ---
        const startScanBtn = document.getElementById('start-scan-button');
        const stopScanBtn = document.getElementById('stop-scan-button');
        const addToInventoryBtn = document.getElementById('add-to-inventory-button');
        const scanAnotherBtn = document.getElementById('scan-another-button');
        const downloadCsvBtn = document.getElementById('download-csv-button');
        const clearInventoryBtn = document.getElementById('clear-inventory-button');
        
        const scannerContainer = document.getElementById('scanner-container');
        const bookInfoDiv = document.getElementById('book-info');
        const loader = document.getElementById('loader');
        const loaderMessage = document.getElementById('loader-message');
        const messageDisplay = document.getElementById('message-display');
        const inventoryCountEl = document.getElementById('inventory-count');

        // --- INITIALIZATION ---
        window.onload = () => {
            // Attach event listeners
            startScanBtn.onclick = startScanning;
            stopScanBtn.onclick = stopScanning;
            addToInventoryBtn.onclick = addToInventory;
            scanAnotherBtn.onclick = () => {
                hideBookInfo();
                startScanning();
            };
            downloadCsvBtn.onclick = downloadCSV;
            clearInventoryBtn.onclick = clearInventory;
        };
        
        // --- UI HELPER FUNCTIONS ---
        function showLoader(visible, message = 'Loading...') {
            loaderMessage.textContent = message;
            loader.classList.toggle('hidden', !visible);
        }

        function showMessage(text, isError = false) {
            messageDisplay.textContent = text;
            messageDisplay.className = `my-4 p-3 rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageDisplay.classList.remove('hidden');
        }
        
        function hideMessage() {
            messageDisplay.classList.add('hidden');
        }

        function showBookInfo(book) {
            document.getElementById('book-title').textContent = book.title;
            document.getElementById('book-author').textContent = book.authors.join(', ');
			
			// Assume 'book' is the object returned from the Google Books API.
			// Check if the authors array exists and is not empty.
			if (book.authors && book.authors.length > 0) {
			  // Use the map() method to reformat each author's name.
			  const formattedAuthors = book.authors.map(author => {
				// Split the author string by the space.
				const nameParts = author.split(' ');
				
				// The last part is the last name. The rest are first names.
				const lastName = nameParts.pop();
				const firstName = nameParts.join(' ');
				
				// Return the reordered name.
				return `${lastName}, ${firstName}`;
			  });

			  // Join the formatted names with a comma and space for display.
			  document.getElementById('book-author').textContent = formattedAuthors.join('; ');
			} else {
			  // Handle cases where no author information is available.
			  document.getElementById('book-author').textContent = 'Author not found';
			}
			
            document.getElementById('book-isbn').textContent = `ISBN: ${book.isbn}`;
            // Store the full book object for later use
            bookInfoDiv.dataset.book = JSON.stringify(book);
            bookInfoDiv.classList.remove('hidden');
        }

        function hideBookInfo() {
            bookInfoDiv.classList.add('hidden');
        }

        function updateInventoryStatus() {
            const count = bookInventory.length;
            inventoryCountEl.textContent = count;
            const hasItems = count > 0;
            downloadCsvBtn.disabled = !hasItems;
            clearInventoryBtn.disabled = !hasItems;
        }

        // --- INVENTORY & CSV FUNCTIONS ---
        function addToInventory() {
            const bookString = bookInfoDiv.dataset.book;
            if (!bookString) return;
            
            const bookData = JSON.parse(bookString);
            bookInventory.push(bookData);
            
            hideBookInfo();
            showMessage(`"${bookData.title}" added to your list.`, false);
            updateInventoryStatus();
            
            // Automatically start scanning for the next book
            setTimeout(() => {
                hideMessage();
                startScanning();
            }, 1500);
        }

        function clearInventory() {
            if (confirm('Are you sure you want to clear your entire list?')) {
                bookInventory = [];
                updateInventoryStatus();
                showMessage('Inventory list has been cleared.', false);
            }
        }

        function downloadCSV() {
            if (bookInventory.length === 0) {
                showMessage('No books in inventory to download.', true);
                return;
            }

            // Define CSV headers
            const headers = ['Title', 'Author Last Name', 'Author First Name','Authors', 'ISBN', 'ISBN Link', 'Publisher', 'PublishedDate', 'PageCount', 'Categories'];
            let csvContent = headers.join(',') + '\r\n';

            // Function to safely format a field for CSV
            const formatCsvField = (field) => {
                if (field === null || field === undefined) return '';
                const stringField = String(field);
                // If the field contains a comma, double quote, or newline, enclose it in double quotes
                if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                    // Escape existing double quotes by doubling them
                    return `"${stringField.replace(/"/g, '""')}"`;
                }
                return stringField;
            };

            // Add rows
			
			//Previous book export code, commented out on 9/3/25 to allow for a reformatted author list.
            //bookInventory.forEach(book => {
            //   const row = [
            //        book.title,
            //        book.authors.join('; '), // Use semicolon in case author names have commas
            //        book.isbn,
			//		"https://isbnsearch.org/isbn/" + book.isbn,
            //        book.publisher,
            //        book.publishedDate,
            //        book.pageCount,
            //        book.categories ? book.categories.join('; ') : ''
            //    ].map(formatCsvField).join(',');
            //    csvContent += row + '\r\n';
            //});

			//Previous book export code, commented out on 9/4/25 to allow for a reformatted author list.
			//bookInventory.forEach(book => {
				// 1. Check if authors exist and reformat them
			//	let reformattedAuthors = '';
			//	if (book.authors && book.authors.length > 0) {
					// Use map() to create a new array with the reformatted names.
			//		const reformattedArray = book.authors.map(author => {
						// Split the name string by a space.
			//			const nameParts = author.split(' ');
						
						// Pop the last element to get the last name.
			//			const lastName = nameParts.pop();
						
						// Join the remaining elements back together for the first name.
			//			const firstName = nameParts.join(' ');
						
						// Return the new "Last, First" format.
			//			return `${lastName}, ${firstName}`;
			//		});
					
					// Join the reformatted names for the CSV field.
			//		reformattedAuthors = reformattedArray.join('; ');
			//	}
			
			//New book export code, added on 9/4/25 to parse Author first and last name into different columns (only the first author is parsed).
			bookInventory.forEach(book => {
				let firstName = '';
				let lastName = '';
				let author = book.authors && book.authors[0]; // Get the first author from the array

			// Check if the first author exists before processing.
			if (author) {
				const nameParts = author.split(' ');
				lastName = nameParts.pop(); // Remove and get the last part
				firstName = nameParts.join(' '); // Join the remaining parts
			}

				const row = [
					book.title,
					lastName,
					firstName,
					book.authors ? book.authors.join('; ') : '', // Keep the original authors column
					//reformattedAuthors, // Add the new reformatted authors column
					book.isbn,
					"https://isbnsearch.org/isbn/" + book.isbn,
					book.publisher,
					book.publishedDate,
					book.pageCount,
					book.categories ? book.categories.join('; ') : ''
				].map(formatCsvField).join(',');

				csvContent += row + '\r\n';
			});


            // Create and download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "book_inventory.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- BARCODE SCANNING ---
        function startScanning() {
            if (API_KEY.includes('YOUR_')) {
                showMessage("Configuration Needed: Please add your Google API Key to the script.", true);
                return;
            }
            hideMessage();
            hideBookInfo();
            scannerContainer.classList.remove('hidden');
            startScanBtn.classList.add('hidden');
            
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 150 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    showMessage("Unable to start camera. Please grant permission.", true);
                    console.error(err);
                    stopScanning();
                });
        }

        function stopScanning() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop scanner.", err));
            }
            scannerContainer.classList.add('hidden');
            startScanBtn.classList.remove('hidden');
        }

        async function onScanSuccess(decodedText, decodedResult) {
            stopScanning();
            showLoader(true, 'Finding book...');
            try {
                const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${decodedText}&key=${API_KEY}`);
                const json = await response.json();
                if (json.totalItems > 0 && json.items[0].volumeInfo) {
                    const volumeInfo = json.items[0].volumeInfo;
                    const book = {
                        isbn: decodedText,
                        title: volumeInfo.title || 'N/A',
                        authors: volumeInfo.authors || ['N/A'],
                        publisher: volumeInfo.publisher || 'N/A',
                        publishedDate: volumeInfo.publishedDate || 'N/A',
                        pageCount: volumeInfo.pageCount || 'N/A',
                        categories: volumeInfo.categories || [],
                    };
                    hideMessage();
                    showBookInfo(book);
                } else {
                    showMessage(`No book found for ISBN: ${decodedText}. You can try scanning again.`, true);
                    setTimeout(startScanning, 2000);
                }
            } catch (e) {
                console.error("Failed to fetch book data", e);
                showMessage("Failed to fetch book data. Check your connection and API Key.", true);
            } finally {
                showLoader(false);
            }
        }
    </script>
	<footer style="font-size: 0.69em;">
		<p>Copyright &copy; 2025 Jay Kenley. All rights reserved. The content on this website is the property of the owner and may not be reproduced without permission.</p>
	</footer>
</body>
</html>
